<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared ToDoLists</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        .list-item:hover,
        .task-item:hover {
            background-color: #f5f5f5;
        }

        .task-item {
            cursor: move;
        }

        .task-textarea {
            border: none;
            background: transparent;
            box-shadow: none;
            resize: none;
            overflow: hidden;
            padding: 0.25rem 0;
        }

        .task-textarea:focus {
            outline: none;
            box-shadow: none;
        }
    </style>
</head>

<body>

<!-- ‚ùó –Ñ–î–ò–ù–ò–ô ROOT -->
<div id="app" x-data="todoApp()" x-init="init()">

    <div class="columns is-gapless" style="min-height:100vh;">

        <!-- –õ–Ü–í–ê –ü–ê–ù–ï–õ–¨ -->
        <div class="column is-3" style="background:#f8f9fa;border-right:1px solid #dee2e6;">
            <div class="section">
                <h2 class="title is-4 mb-4">–°–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á</h2>

                <!-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É -->
                <div class="field has-addons mb-5">
                    <div class="control is-expanded">
                        <input class="input"
                               placeholder="–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫—É"
                               x-model="newListName"
                               @keyup.enter="createList">
                    </div>
                    <div class="control">
                        <button class="button is-primary" @click="createList">
                            –°—Ç–≤–æ—Ä–∏—Ç–∏
                        </button>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–∫–∏ -->
                <div class="list" style="max-height:calc(100vh - 250px);overflow-y:auto;">
                    <template x-for="list in lists" :key="list.id">
                        <div class="list-item box mb-2"
                             :class="{'has-background-primary-light': list.id === selectedListId}"
                             @click="selectList(list.id)">

                            <div class="columns is-mobile is-vcentered">
                                <div class="column">
                                    <input
                                        class="input is-small"
                                        x-model="list.name"
                                        @click.stop
                                        @blur="updateListName(list)"
                                        @keyup.enter="$event.target.blur()"
                                        style="border:none;background:transparent;box-shadow:none;"
                                    >
                                </div>

                                <div class="column is-narrow">
                                    <button class="button is-small is-text"
                                            @click.stop="copyListLink(list.id)"
                                            title="–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è">
                                        üîó
                                    </button>
                                    <button class="button is-small is-text has-text-danger"
                                            @click.stop="deleteList(list.id)"
                                            title="–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ø–∏—Å–æ–∫">
                                        üóë
                                    </button>
                                </div>
                            </div>

                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ê –ß–ê–°–¢–ò–ù–ê -->
        <div class="column">
            <div class="section" x-show="selectedListId">

                <h2 class="title is-4 mb-4" x-text="selectedListName"></h2>

                <!-- –ù–æ–≤–∞ –∑–∞–¥–∞—á–∞ -->
                <div class="field has-addons mb-5">
                    <div class="control is-expanded">
                        <input class="input"
                               placeholder="–ù–æ–≤–∞ –∑–∞–¥–∞—á–∞"
                               x-model="newTaskText"
                               @keyup.enter="createTask">
                    </div>
                    <div class="control">
                        <button class="button is-primary" @click="createTask">
                            –î–æ–¥–∞—Ç–∏
                        </button>
                    </div>
                </div>

                <!-- –ó–∞–¥–∞—á—ñ -->
                <div class="list">
                    <template x-for="(task, index) in tasks" :key="task.id">
                        <div class="task-item box mb-2"
                             draggable="true"
                             @dragstart="dragStart(index, $event)"
                             @dragover.prevent
                             @drop="drop(index)"
                             @dragend="dragEnd($event)">

                            <div class="columns is-mobile is-vcentered">
                                <div class="column is-narrow">‚ò∞</div>

                                <div class="column">
                                    <textarea
                                        class="textarea task-textarea"
                                        rows="1"
                                        x-model="task.text"
                                        @input="$el.style.height='auto';$el.style.height=$el.scrollHeight+'px'"
                                        @blur="updateTask(task)"
                                    ></textarea>
                                </div>

                                <div class="column is-narrow">
                                    <button class="button is-small is-success"
                                            @click="completeTask(task.id)">‚úì</button>
                                    <button class="button is-small is-text has-text-danger"
                                            @click="deleteTask(task.id)">üóë</button>
                                </div>
                            </div>

                        </div>
                    </template>
                </div>

                <p class="has-text-grey" x-show="tasks.length === 0">
                    –ù–µ–º–∞—î –∑–∞–¥–∞—á
                </p>
            </div>
        </div>

    </div>
</div>

<script>
function todoApp() {
    return {
        lists: [],
        tasks: [],
        selectedListId: null,
        selectedListName: '',
        newListName: '',
        newTaskText: '',
        draggedIndex: null,
        initialized: false,

        async init() {
            if (this.initialized) return;
            this.initialized = true;
            await this.loadLists();
        },

        async loadLists() {
            this.lists = await (await fetch('/api/lists')).json();
        },

        async selectList(id) {
            this.selectedListId = id;
            this.selectedListName = this.lists.find(l => l.id === id)?.name || '';
            this.tasks = await (await fetch(`/api/lists/${id}/tasks`)).json();
        },

        async createList() {
            if (!this.newListName.trim()) return;
            const r = await fetch('/api/lists', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({name: this.newListName})
            });
            const list = await r.json();
            this.lists.push(list);
            this.newListName = '';
            this.selectList(list.id);
        },

        async updateListName(list) {
            await fetch(`/api/lists/${list.id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({name: list.name})
            });
        },

        async deleteList(id) {
            //if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ø–∏—Å–æ–∫?')) return;
            await fetch(`/api/lists/${id}`, {method:'DELETE'});
            this.lists = this.lists.filter(l => l.id !== id);
            if (this.selectedListId === id) {
                this.selectedListId = null;
                this.tasks = [];
            }
        },

        copyListLink(id) {
            navigator.clipboard.writeText(`${location.origin}/view/${id}`);
            //alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ');
        },

        async createTask() {
            if (!this.newTaskText.trim()) return;
            const r = await fetch(`/api/lists/${this.selectedListId}/tasks`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({text: this.newTaskText})
            });
            this.tasks.push(await r.json());
            this.newTaskText = '';
        },

        async updateTask(task) {
            await fetch(`/api/tasks/${task.id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({text: task.text})
            });
        },

        async completeTask(id) {
            await fetch(`/api/tasks/${id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({completed:true})
            });
            this.tasks = this.tasks.filter(t => t.id !== id);
        },

        async deleteTask(id) {
            await fetch(`/api/tasks/${id}`, {method:'DELETE'});
            this.tasks = this.tasks.filter(t => t.id !== id);
        },

        dragStart(i,e){ this.draggedIndex=i; e.target.style.opacity=.5 },
        dragEnd(e){ e.target.style.opacity=1; this.draggedIndex=null },

        drop(i){
            const t = this.tasks.splice(this.draggedIndex,1)[0];
            this.tasks.splice(i,0,t);
        }
    }
}
</script>

</body>
</html>
