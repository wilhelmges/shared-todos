<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared ToDoLists - Редагування</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .list-item:hover {
            background-color: #f5f5f5;
        }
        .task-item {
            cursor: move;
        }
        .task-item:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div x-data="todoApp()" x-init="loadLists()">
        <div class="columns is-gapless" style="min-height: 100vh;">
            <!-- Ліва панель зі списками -->
            <div class="column is-3" style="background-color: #f8f9fa; border-right: 1px solid #dee2e6;">
                <div class="section">
                    <h2 class="title is-4 mb-4">Списки задач</h2>
                    
                    <!-- Форма створення нового списку -->
                    <div class="field has-addons mb-5">
                        <div class="control is-expanded">
                            <input 
                                class="input" 
                                type="text" 
                                placeholder="Назва нового списку"
                                x-model="newListName"
                                @keyup.enter="createList()"
                            >
                        </div>
                        <div class="control">
                            <button class="button is-primary" @click="createList()">Створити</button>
                        </div>
                    </div>
                    
                    <!-- Списки задач -->
                    <div class="list" style="max-height: calc(100vh - 250px); overflow-y: auto;">
                        <template x-for="list in lists" :key="list.id">
                            <div 
                                class="list-item box mb-2" 
                                :class="{'has-background-primary-light': selectedListId === list.id}"
                                @click="selectList(list.id)"
                            >
                                <div class="level is-mobile mb-1">
                                    <div class="level-left">
                                        <div class="level-item">
                                            <input 
                                                class="input is-small" 
                                                type="text" 
                                                x-model="list.name"
                                                @blur="updateListName(list.id, list.name)"
                                                @keyup.enter="$event.target.blur()"
                                                @click.stop
                                                style="border: none; background: transparent; box-shadow: none;"
                                            >
                                        </div>
                                    </div>
                                    <div class="level-right">
                                        <div class="level-item">
                                            <button 
                                                class="button is-small is-text"
                                                @click.stop="copyListLink(list.id)"
                                                title="Копіювати посилання"
                                            >
                                                <span class="icon is-small">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M13.5 1a1.5 1.5 0 0 0-1.5 1.5v10a1.5 1.5 0 0 0 1.5 1.5h1a1.5 1.5 0 0 0 1.5-1.5v-10a1.5 1.5 0 0 0-1.5-1.5h-1zM11 2.5v9a.5.5 0 0 1-.5.5h-1A1.5 1.5 0 0 1 8 11.5v-9A1.5 1.5 0 0 1 9.5 1h1a.5.5 0 0 1 .5.5z"/>
                                                        <path d="M5 2a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-11A.5.5 0 0 0 9 2H5zm0 1h4v10H5V3z"/>
                                                    </svg>
                                                </span>
                                            </button>
                                            <button 
                                                class="button is-small is-text has-text-danger"
                                                @click.stop="deleteList(list.id)"
                                                title="Видалити список"
                                            >
                                                <span class="icon is-small">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                    </svg>
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Основна частина з задачами -->
            <div class="column">
                <div class="section" x-show="selectedListId">
                    <template x-if="selectedListId">
                        <div>
                            <h2 class="title is-4 mb-4" x-text="selectedListName"></h2>
                            
                            <!-- Форма додавання нової задачі -->
                            <div class="field has-addons mb-5">
                                <div class="control is-expanded">
                                    <input 
                                        class="input" 
                                        type="text" 
                                        placeholder="Нова задача"
                                        x-model="newTaskText"
                                        @keyup.enter="createTask()"
                                    >
                                </div>
                                <div class="control">
                                    <button class="button is-primary" @click="createTask()">Додати задачу</button>
                                </div>
                            </div>
                            
                            <!-- Список задач -->
                            <div class="list">
                                <template x-for="(task, index) in tasks" :key="task.id">
                                    <div 
                                        class="task-item box mb-2"
                                        draggable="true"
                                        @dragstart="dragStart(index, $event)"
                                        @dragover.prevent="dragOver(index, $event)"
                                        @drop="drop(index, $event)"
                                        @dragend="dragEnd()"
                                    >
                                        <div class="level is-mobile">
                                            <div class="level-left">
                                                <div class="level-item">
                                                    <span class="icon has-text-grey" style="cursor: move;">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M7 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zM2 1a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V1zm2 0v13h8V1H4z"/>
                                                            <path d="M5.5 4.5A.5.5 0 0 1 6 4h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5zm0 2A.5.5 0 0 1 6 6h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5zm0 2A.5.5 0 0 1 6 8h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5z"/>
                                                        </svg>
                                                    </span>
                                                    <input 
                                                        class="input ml-2" 
                                                        type="text" 
                                                        x-model="task.text"
                                                        @blur="updateTaskText(task.id, task.text)"
                                                        @keyup.enter="$event.target.blur()"
                                                        style="border: none; background: transparent; box-shadow: none;"
                                                    >
                                                </div>
                                            </div>
                                            <div class="level-right">
                                                <div class="level-item">
                                                    <button 
                                                        class="button is-small is-success"
                                                        @click="completeTask(task.id)"
                                                        title="Позначити як виконану"
                                                    >
                                                        <span class="icon is-small">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                                            </svg>
                                                        </span>
                                                    </button>
                                                    <button 
                                                        class="button is-small is-text has-text-danger"
                                                        @click="deleteTask(task.id)"
                                                        title="Видалити задачу"
                                                    >
                                                        <span class="icon is-small">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                            </svg>
                                                        </span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <p class="has-text-grey" x-show="tasks.length === 0">Немає задач у цьому списку</p>
                        </div>
                    </template>
                    
                    <div x-show="!selectedListId" class="has-text-centered has-text-grey" style="margin-top: 50px;">
                        <p>Виберіть список задач зліва або створіть новий</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function todoApp() {
            return {
                lists: [],
                tasks: [],
                selectedListId: null,
                selectedListName: '',
                newListName: '',
                newTaskText: '',
                draggedIndex: null,
                
                async loadLists() {
                    try {
                        const response = await fetch('/api/lists');
                        this.lists = await response.json();
                    } catch (error) {
                        console.error('Помилка завантаження списків:', error);
                    }
                },
                
                async selectList(listId) {
                    this.selectedListId = listId;
                    const list = this.lists.find(l => l.id === listId);
                    this.selectedListName = list ? list.name : '';
                    await this.loadTasks();
                },
                
                async loadTasks() {
                    if (!this.selectedListId) return;
                    
                    try {
                        const response = await fetch(`/api/lists/${this.selectedListId}/tasks`);
                        this.tasks = await response.json();
                    } catch (error) {
                        console.error('Помилка завантаження задач:', error);
                    }
                },
                
                async createList() {
                    if (!this.newListName.trim()) return;
                    
                    try {
                        const response = await fetch('/api/lists', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: this.newListName })
                        });
                        
                        if (response.ok) {
                            const newList = await response.json();
                            this.lists.push(newList);
                            this.newListName = '';
                            await this.selectList(newList.id);
                        }
                    } catch (error) {
                        console.error('Помилка створення списку:', error);
                    }
                },
                
                async updateListName(listId, name) {
                    if (!name.trim()) return;
                    
                    try {
                        const response = await fetch(`/api/lists/${listId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        });
                        
                        if (response.ok) {
                            const updated = await response.json();
                            const index = this.lists.findIndex(l => l.id === listId);
                            if (index !== -1) {
                                this.lists[index] = updated;
                            }
                            if (this.selectedListId === listId) {
                                this.selectedListName = name;
                            }
                        }
                    } catch (error) {
                        console.error('Помилка оновлення списку:', error);
                    }
                },
                
                async deleteList(listId) {
                    if (!confirm('Ви впевнені, що хочете видалити цей список?')) return;
                    
                    try {
                        const response = await fetch(`/api/lists/${listId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            this.lists = this.lists.filter(l => l.id !== listId);
                            if (this.selectedListId === listId) {
                                this.selectedListId = null;
                                this.tasks = [];
                            }
                        }
                    } catch (error) {
                        console.error('Помилка видалення списку:', error);
                    }
                },
                
                async copyListLink(listId) {
                    const url = `${window.location.origin}/view/${listId}`;
                    try {
                        await navigator.clipboard.writeText(url);
                        alert('Посилання скопійовано в буфер обміну!');
                    } catch (error) {
                        // Fallback для старих браузерів
                        const textarea = document.createElement('textarea');
                        textarea.value = url;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        alert('Посилання скопійовано в буфер обміну!');
                    }
                },
                
                async createTask() {
                    if (!this.newTaskText.trim() || !this.selectedListId) return;
                    
                    try {
                        const response = await fetch(`/api/lists/${this.selectedListId}/tasks`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: this.newTaskText })
                        });
                        
                        if (response.ok) {
                            const newTask = await response.json();
                            this.tasks.push(newTask);
                            this.newTaskText = '';
                        }
                    } catch (error) {
                        console.error('Помилка створення задачі:', error);
                    }
                },
                
                async updateTaskText(taskId, text) {
                    if (!text.trim()) return;
                    
                    try {
                        const response = await fetch(`/api/tasks/${taskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text })
                        });
                        
                        if (response.ok) {
                            const updated = await response.json();
                            const index = this.tasks.findIndex(t => t.id === taskId);
                            if (index !== -1) {
                                this.tasks[index] = updated;
                            }
                        }
                    } catch (error) {
                        console.error('Помилка оновлення задачі:', error);
                    }
                },
                
                async completeTask(taskId) {
                    try {
                        const response = await fetch(`/api/tasks/${taskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ completed: true })
                        });
                        
                        if (response.ok) {
                            // Видаляємо задачу зі списку (вона виконана)
                            this.tasks = this.tasks.filter(t => t.id !== taskId);
                        }
                    } catch (error) {
                        console.error('Помилка позначення задачі:', error);
                    }
                },
                
                async deleteTask(taskId) {
                    try {
                        const response = await fetch(`/api/tasks/${taskId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            this.tasks = this.tasks.filter(t => t.id !== taskId);
                        }
                    } catch (error) {
                        console.error('Помилка видалення задачі:', error);
                    }
                },
                
                dragStart(index, event) {
                    this.draggedIndex = index;
                    event.dataTransfer.effectAllowed = 'move';
                    event.target.style.opacity = '0.5';
                },
                
                dragOver(index, event) {
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'move';
                },
                
                async drop(targetIndex, event) {
                    event.preventDefault();
                    
                    if (this.draggedIndex === null || this.draggedIndex === targetIndex) {
                        return;
                    }
                    
                    const draggedTask = this.tasks[this.draggedIndex];
                    const originalTasks = [...this.tasks];
                    
                    // Переміщуємо задачу в масиві
                    const newTasks = [...this.tasks];
                    newTasks.splice(this.draggedIndex, 1);
                    newTasks.splice(targetIndex, 0, draggedTask);
                    this.tasks = newTasks;
                    
                    // Розраховуємо нову позицію на основі нових позицій задач
                    let newPosition;
                    if (targetIndex === 0) {
                        // Переміщення на початок
                        if (newTasks.length > 1) {
                            newPosition = newTasks[1].position - 1.0;
                        } else {
                            newPosition = 1.0;
                        }
                    } else if (targetIndex === newTasks.length - 1) {
                        // Переміщення в кінець
                        newPosition = newTasks[targetIndex - 1].position + 1.0;
                    } else {
                        // Переміщення між задачами
                        const prevPos = newTasks[targetIndex - 1].position;
                        const nextPos = newTasks[targetIndex + 1].position;
                        newPosition = (prevPos + nextPos) / 2.0;
                    }
                    
                    // Оновлюємо позицію в БД
                    try {
                        await fetch(`/api/tasks/${draggedTask.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ position: newPosition })
                        });
                    } catch (error) {
                        console.error('Помилка оновлення позиції:', error);
                        // Відкат у разі помилки
                        this.tasks = originalTasks;
                    }
                },
                
                dragEnd(event) {
                    event.target.style.opacity = '';
                    this.draggedIndex = null;
                }
            }
        }
    </script>
</body>
</html>
